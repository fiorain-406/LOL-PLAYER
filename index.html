<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>내전 관리 사이트</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, writeBatch } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAgdmpzynIp1ciAM78cttMqtsWReqmOAfM",
  authDomain: "lol-player-8f92b.firebaseapp.com",
  projectId: "lol-player-8f92b",
  storageBucket: "lol-player-8f92b.appspot.com",
  messagingSenderId: "497657121304",
  appId: "1:497657121304:web:3c3c8678290d9fff99116d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firestoreDB = db;

async function createTestUser() {
  try {
    await addDoc(collection(db, "users"), {
      userId: 1,
      userName: "테스트유저",
      rating: 1000,
      tier: "브론즈 5",
      mainLane: "-",
      subLane: "-",
      win: 0,
      loss: 0,
      matchNumber: 0,
      winRate: "0%",
      lastPlayDateSince: "-"
    });
    console.log("✅ users 컬렉션과 문서 생성 완료");
  } catch(e) {
    console.error(e);
  }
}

createTestUser();
</script>

<style>
:root{--card:#2a2a2a;--accent1:#ffb347;--accent2:#ff8c42;--text:#f0f0f0;--muted:#555}
*{box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,sans-serif;background:#222;margin:0;padding:20px;color:var(--text)}
nav{text-align:center;margin-bottom:30px}
nav button{background:linear-gradient(145deg,var(--accent1),#ffcc80);color:#121212;border:none;padding:10px 18px;margin:0 5px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 6px rgba(0,0,0,.5);transition:.2s}
nav button:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1));transform:translateY(-2px)}
.section{background:var(--card);padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.5);margin-bottom:40px}

table.dataTable{width:100%;border-collapse:collapse;color:var(--text)}
table.dataTable th{background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212;font-weight:700}
table.dataTable td, table.dataTable th{padding:10px;text-align:center;border:1px solid #444}
table.dataTable tbody tr:hover td{background:#ffcc80 !important;color:#121212 !important;transition:.12s}
tr.editing td{background:#ffd8a8 !important;color:#121212}

.pill{padding:2px 6px;margin:2px;border-radius:4px;display:inline-block;color:#121212}
.winner{background:#87CEFA}
.loser{background:#F08080}

.actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.btn{color:#121212;background:linear-gradient(145deg,var(--accent1),var(--accent2));border:none;padding:6px 10px;border-radius:8px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.4);font-weight:600}
.btn:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1))}
.fixed-btn{position:fixed;bottom:20px;right:20px;z-index:1000;padding:12px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 5px 10px rgba(0,0,0,.5);color:#121212;background:linear-gradient(145deg,var(--accent1),#ffcc80);transition:.2s}
.fixed-btn:hover{transform:translateY(-2px);background:linear-gradient(145deg,var(--accent2),var(--accent1))}

.toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.grid-1{display:grid;grid-template-columns:1fr;gap:20px}

select.match-p, select.log-p, .select2{width:100%}
.select2-container--default .select2-selection--single{background:var(--card);border:1px solid var(--muted);border-radius:6px;height:44px}
.select2-container--default .select2-selection--single .select2-selection__rendered{line-height:42px;color:var(--text);padding-left:8px}
.select2-dropdown,.select2-container--default .select2-results > .select2-results__options{background:var(--card);color:var(--text)}
.select2-results__option[aria-selected="true"],.select2-results__option--highlighted[aria-selected]{background:#ffcc80;color:#121212}

input[type=text], input[type=number], input[type=date]{padding:8px;border-radius:6px;border:1px solid var(--muted);background:var(--card);color:var(--text)}

#match-result table{width:100%;border-collapse:collapse;margin-top:12px;color:var(--text)}
#match-result th{background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212}
#match-result td,#match-result th{border:1px solid #444;padding:8px;text-align:center}

@media (max-width:820px){.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>

<nav>
  <button id="menu-dashboard">대시보드</button>
  <button id="menu-match">자동 팀 생성</button>
  <button id="menu-log">내전 기록</button>
</nav>

<section id="section-dashboard" class="section">
  <table id="userTable" class="display">
    <thead>
      <tr>
        <th>No</th><th>이름</th><th>티어</th><th>레이팅</th><th>주라인</th><th>부라인</th>
        <th>판수</th><th>승리</th><th>패배</th><th>승률</th><th>최근 경기</th><th>메뉴</th>
      </tr>
    </thead>
  </table>
</section>

<section id="section-match" class="section" style="display:none;">
  <div id="match-team" class="grid-2"></div>
  <br>
  <button id="btn-match" class="fixed-btn">매칭하기</button>

  <div id="match-result">
    <h3>팀 매치 결과</h3>
    <table>
      <thead><tr><th>블루팀</th><th>레드팀</th></tr></thead>
      <tbody><tr><td colspan="2" style="text-align:center">매칭하기 버튼을 눌러 결과 확인</td></tr></tbody>
    </table>
  </div>
</section>

<section id="section-log" class="section" style="display:none;">
  <div id="log-players-header" class="grid-2">
    <div>승리팀</div>
    <div>패배팀</div>
  </div>

  <div id="log-players" class="grid-2"></div>
  <br>

  <div id="log-result">
    <h3>최근 기록</h3>
    <table>
      <thead><tr>
        <th class="date-col">날짜</th>
        <th>승리팀 멤버</th>
        <th>패배팀 멤버</th>
        <th>메뉴</th>
      </tr></thead>
      <tbody><tr><td colspan="4" style="text-align:center">저장된 기록이 없습니다.</td></tr></tbody>
    </table>
  </div>
</section>

<button id="start-edit-btn" class="fixed-btn" style="right:20px; bottom:20px;">편집하기</button>
<button id="edit-users-btn" class="fixed-btn" style="bottom:50px; display:none;">유저 수정 완료</button>
<button id="btn-add-user-bottom" class="fixed-btn" style="bottom:20px; display:none;">유저 추가</button>
<button id="btn-log-save" class="fixed-btn" style="right:20px; bottom:20px;">기록 저장</button>

<script>
let editable = false;
let idCounter = 0;
const allowedUsers = ['admin'];
let currentUser = prompt("사용자 이름을 입력하세요:") || '';

if(!allowedUsers.includes(currentUser)){
  $('#menu-log').hide();
  $('#start-edit-btn').hide();
  $('#btn-log-save').hide();
}

function updateUserEditButtonVisibility(){
  if($('#section-dashboard').is(':visible')){
    if(editable){
      $('#start-edit-btn').hide();
      $('#edit-users-btn').show();
      $('#btn-add-user-bottom').show();
    } else if(allowedUsers.includes(currentUser)){
      $('#start-edit-btn').show();
      $('#edit-users-btn').hide();
      $('#btn-add-user-bottom').hide();
    }
  } else { 
    $('#start-edit-btn,#edit-users-btn,#btn-add-user-bottom').hide(); 
  }

  $('#btn-match').toggle($('#section-match').is(':visible'));
  $('#btn-log-save').toggle($('#section-log').is(':visible') && allowedUsers.includes(currentUser));
}

$('nav button').click(function(){
  $('.section').hide();
  if(this.id==='menu-dashboard') $('#section-dashboard').show();
  if(this.id==='menu-match'){ 
    $('#section-match').show();
    initPlayers();
  }
  if(this.id==='menu-log'){ 
    $('#section-log').show(); 
    initPlayers(); 
    loadLogs(); 
  }
  updateUserEditButtonVisibility();
});

var userTable = $('#userTable').DataTable({
  paging:false, serverSide:false, data:[], autoWidth:false,
  columns:[
    {data:null, render:(d,t,r,m)=> m.row+1},
    {data:"userName"}, {data:"tier"}, {data:"rating"}, {data:"mainLane"}, {data:"subLane"},
    {data:"matchNumber"}, {data:"win"}, {data:"loss"}, {data:"winRate"}, {data:"lastPlayDateSince"},
    {data:null, defaultContent:'<button class="delete-btn">삭제</button>', orderable:false}
  ],
  columnDefs:[{targets:1,width:'17%',className:'dt-left'},{targets:4,width:'7%'},{targets:5,width:'7%'},{targets:10,width:'8%'}]
});

userTable.on('draw', function(){
  applyTierColors();
  updateDeleteButtons();
});

function calculateWinRate(win, match){ return match===0 ? '0%' : Math.round((win/match)*100)+'%'; }

function getTierByRating(r){
  if(!r) return'아이언';
  r=+r;
  if(r>=3000) return'챌린저'; if(r>=2900) return'그마'; if(r>=2800) return'마스터 3'; if(r>=2700) return'마스터 2'; if(r>=2600) return'마스터 1'; if(r>=2500) return'마스터 0';
  if(r>=2450) return'다이아 1'; if(r>=2400) return'다이아 2'; if(r>=2350) return'다이아 3'; if(r>=2300) return'다이아 4'; if(r>=2250) return'다이아 5';
  if(r>=2200) return'에메랄드 1'; if(r>=2150) return'에메랄드 2'; if(r>=2100) return'에메랄드 3'; if(r>=2050) return'에메랄드 4'; if(r>=2000) return'에메랄드 5';
  if(r>=1950) return'플레티넘 1'; if(r>=1900) return'플레티넘 2'; if(r>=1850) return'플레티넘 3'; if(r>=1800) return'플레티넘 4'; if(r>=1750) return'플레티넘 5';
  if(r>=1700) return'골드 1'; if(r>=1650) return'골드 2'; if(r>=1600) return'골드 3'; if(r>=1550) return'골드 4'; if(r>=1500) return'골드 5';
  if(r>=1450) return'실버 1'; if(r>=1400) return'실버 2'; if(r>=1350) return'실버 3'; if(r>=1300) return'실버 4'; if(r>=1250) return'실버 5';
  if(r>=1200) return'브론즈 1'; if(r>=1150) return'브론즈 2'; if(r>=1100) return'브론즈 3'; if(r>=1050) return'브론즈 4'; if(r>=1000) return'브론즈 5';
  return'아이언';
}

function applyTierColors(){
  $('#userTable tbody tr').each(function(){
    let $td = $(this).find('td').eq(2), tier = $td.text().trim(), bg='#2a2a2a', color='#f0f0f0';
    if(tier.includes('아이언')) { bg='#fff'; color='#121212'; }
    else if(tier.includes('브론즈')) { bg='#DEB84F'; color='#121212'; }
    else if(tier.includes('실버')) { bg='#BDBDBD'; color='#121212'; }
    else if(tier.includes('골드')) { bg='#FAED7D'; color='#121212'; }
    else if(tier.includes('플레티넘')) { bg='#ABF200'; color='#121212'; }
    else if(tier.includes('에메랄드')) { bg='#2FED28'; color='#121212'; }
    else if(tier.includes('다이아')) { bg='#00D8FF'; color='#121212'; }
    else if(tier.includes('마스터')) { bg='#C98AFF'; color='#121212'; }
    else if(tier.includes('그마')) { bg='#FF3636'; color='#121212'; }
    else if(tier.includes('챌린저')) { bg='linear-gradient(to right,#ffd700,#1e90ff)'; color='#121212'; }
    $td.css(tier.includes('챌린저') ? {'background':bg,'color':color,'font-weight':'600'} : {'background-color':bg,'color':color,'font-weight':'600'});
  });
}

async function saveUsersToLocalStorage() {
  try {
    const users = userTable.rows().data().toArray();
    const batch = writeBatch(window.firestoreDB);

    users.forEach(u => {
      u.matchNumber = (u.win||0) + (u.loss||0);
      u.winRate = calculateWinRate(u.win||0, u.matchNumber);
      u.tier = getTierByRating(u.rating||0);
      u.userId = u.userId || (++idCounter);

      const ref = doc(window.firestoreDB, 'users', String(u.userId));
      batch.set(ref, u);  // Firestore에 저장
    });

    await batch.commit();
    console.log("✅ Firestore 저장 성공");
  } catch (e) {
    console.error("❌ save users error", e);
  }
}

$('#btn-add-user-bottom').off('click').on('click', function(){
  let newId = ++idCounter;
  let newUser = { userId:newId, userName:'이름', rating:1000, mainLane:'-', subLane:'-', win:0, loss:0, lastPlayDateSince:'-' };
  newUser.matchNumber = 0; newUser.winRate = calculateWinRate(0,0); newUser.tier = getTierByRating(newUser.rating);
  userTable.row.add(newUser).draw(false);
  applyTierColors();
  updateDeleteButtons();
  saveUsersToLocalStorage();
});

$('#start-edit-btn').off('click').on('click', function(){ editable=true; updateUserEditButtonVisibility(); updateDeleteButtons(); });
$('#edit-users-btn').off('click').on('click', function(){ editable=false; saveUsersToLocalStorage(); updateUserEditButtonVisibility(); updateDeleteButtons(); });

function updateDeleteButtons(){ $('#userTable tbody tr .delete-btn').toggle(editable); }

$('#userTable tbody').off('click', '.delete-btn').on('click','.delete-btn', function(){
  if(!editable || !confirm('정말 삭제하시겠습니까?')) return;
  userTable.row($(this).closest('tr')).remove().draw(false);
  saveUsersToLocalStorage();
});

$('#userTable').off('click','td').on('click','td', function(){
  if(!editable) return;
  let cell = userTable.cell(this);
  if(!cell.index()) return;
  let colIdx = cell.index().column;
  if([0,2,6,9,11].includes(colIdx)) return;
  let orig = cell.data();
  let $input = $('<input>').val(orig);
  if([3,7,8].includes(colIdx)) $input.attr('type','number').attr('min',0);
  $(this).html($input); $(this).closest('tr').addClass('editing'); $input.focus();
  function finish(){
    let val = $input.val();
    if([3,7,8].includes(colIdx)){ val = val===''?0:Number(val); if(isNaN(val)) val=0; }
    cell.data(val).draw(false); $(cell.node()).closest('tr').removeClass('editing');
    updateStatsIfNeeded(colIdx, cell.index().row);
  }
  $input.on('blur', finish).on('keydown', e=>{ if(e.key==='Enter') finish(); if(e.key==='Escape'){ cell.data(orig).draw(false); $(cell.node()).closest('tr').removeClass('editing'); }}); 
});

function updateStatsIfNeeded(colIdx,rowIdx){
  let data=userTable.row(rowIdx).data();
  data.win=parseInt(data.win)||0; data.loss=parseInt(data.loss)||0;
  data.matchNumber=data.win+data.loss; data.winRate=calculateWinRate(data.win,data.matchNumber);
  if(colIdx===3) data.tier=getTierByRating(parseInt(data.rating)||0);
  userTable.row(rowIdx).data(data).invalidate().draw(false);
  updateDeleteButtons(); applyTierColors();
}

function buildSelects(containerId,className,count){
  const $cont=$('#'+containerId);
  $cont.empty();
  for(let i=1;i<=count;i++) $cont.append(`<select class="${className}" id="${containerId}-${i}"></select>`);
}

function refreshSelectOptions(selector){
  let users=userTable.rows().data().toArray();
  let selected=$(selector).map(function(){ return $(this).val(); }).get().filter(v=>v).map(String);
  let selectedSet=new Set(selected);
  $(selector).each(function(){
    let sel=$(this), curVal=sel.val();
    if(sel.hasClass('select2-hidden-accessible')) sel.select2('destroy');
    sel.empty().append('<option value=""></option>');
    users.forEach(u=>{ if(!selectedSet.has(String(u.userId))||String(u.userId)===String(curVal)) sel.append($('<option>').val(u.userId).text(u.userName)); });
    sel.val(curVal||'').select2({placeholder:'선수 선택',width:'100%',allowClear:true});
  });
}

function initPlayers(){
  if($('#match-team').children().length===0) buildSelects('match-team','match-p',10);
  if($('#log-players').children().length===0) buildSelects('log-players','log-p',10);
  refreshSelectOptions('.match-p');
  refreshSelectOptions('.log-p');
  $('.match-p').off('change.unique').on('change.unique', ()=>refreshSelectOptions('.match-p'));
  $('.log-p').off('change.unique').on('change.unique', ()=>refreshSelectOptions('.log-p'));
}

function generateBalancedTeams(selectedUsers){
  let bestDiff=Infinity, bestTeams=null;
  function combinations(arr,k){ let res=[]; (function c(s,p){ if(p.length===k){res.push(p.slice());return;} for(let i=s;i<arr.length;i++){p.push(arr[i]); c(i+1,p); p.pop();}})(0,[]); return res; }
  let comb = combinations(selectedUsers,5);
  comb.forEach(teamA=>{
    let teamB = selectedUsers.filter(u=>!teamA.includes(u));
    let sumA = teamA.reduce((s,u)=>s+ (parseInt(u.rating||0)),0), sumB = teamB.reduce((s,u)=>s+ (parseInt(u.rating||0)),0);
    let avgA=Math.round(sumA/5), avgB=Math.round(sumB/5), diff=Math.abs(avgA-avgB);
    if(diff < bestDiff){ bestDiff=diff; bestTeams={teamA:teamA.slice(),teamB:teamB.slice(),avgA,avgB}; }
  });
  return bestTeams;
}

$('#btn-match').off('click').on('click', function(){
  let selected = $('.match-p').map(function(){ return $(this).val(); }).get().filter(v=>v);
  if(selected.length<10){ alert('10명을 선택해주세요.'); return; }
  let users=userTable.rows().data().toArray().filter(u=>selected.includes(String(u.userId)));
  let teams=generateBalancedTeams(users);
  if(!teams) return alert('팀 구성 실패');
  let $tbody=$('#match-result tbody'); $tbody.empty();
  let teamARow=teams.teamA.map(u=>u.userName).join(', '), teamBRow=teams.teamB.map(u=>u.userName).join(', ');
  $tbody.append(`<tr><td>${teamARow} (${teams.avgA})</td><td>${teamBRow} (${teams.avgB})</td></tr>`);
});

$(document).ready(function(){
  updateUserEditButtonVisibility();
});

</script>

</body>
</html>
