<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>내전 관리 사이트</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

  <style>
    :root{--card:#2a2a2a;--accent1:#ffb347;--accent2:#ff8c42;--text:#f0f0f0;--muted:#555}
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,sans-serif;background:#222;margin:0;padding:20px;color:var(--text)}
    nav{text-align:center;margin-bottom:30px}
    nav button{background:linear-gradient(145deg,var(--accent1),#ffcc80);color:#121212;border:none;padding:10px 18px;margin:0 5px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 6px rgba(0,0,0,.5);transition:.2s}
    nav button:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1));transform:translateY(-2px)}
    .section{background:var(--card);padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.5);margin-bottom:40px}

    table.dataTable{width:100%;border-collapse:collapse;color:var(--text)}
    table.dataTable th{background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212;font-weight:700}
    table.dataTable td, table.dataTable th{padding:10px;text-align:center;border:1px solid #444}
    table.dataTable tbody tr:hover td{background:#ffcc80 !important;color:#121212 !important;transition:.12s}
    tr.editing td{background:#ffd8a8 !important;color:#121212}

    .pill{padding:2px 6px;margin:2px;border-radius:4px;display:inline-block;color:#121212}
    .winner{background:#87CEFA}
    .loser{background:#F08080}

    .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .btn{color:#121212;background:linear-gradient(145deg,var(--accent1),var(--accent2));border:none;padding:6px 10px;border-radius:8px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.4);font-weight:600}
    .btn:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1))}
    .fixed-btn{position:fixed;bottom:20px;right:20px;z-index:1000;padding:12px 20px;border:none;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 5px 10px rgba(0,0,0,.5);color:#121212;background:linear-gradient(145deg,var(--accent1),#ffcc80);transition:.2s}
    .fixed-btn:hover{transform:translateY(-2px);background:linear-gradient(145deg,var(--accent2),var(--accent1))}

    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .grid-1{display:grid;grid-template-columns:1fr;gap:20px}

    select.match-p, select.log-p, .select2{width:100%}
    .select2-container--default .select2-selection--single{background:var(--card);border:1px solid var(--muted);border-radius:6px;height:44px}
    .select2-container--default .select2-selection--single .select2-selection__rendered{line-height:42px;color:var(--text);padding-left:8px}
    .select2-dropdown,.select2-container--default .select2-results > .select2-results__options{background:var(--card);color:var(--text)}
    .select2-results__option[aria-selected="true"],.select2-results__option--highlighted[aria-selected]{background:#ffcc80;color:#121212}

    input[type=text], input[type=number], input[type=date]{padding:8px;border-radius:6px;border:1px solid var(--muted);background:var(--card);color:var(--text)}

    #match-result table{width:100%;border-collapse:collapse;margin-top:12px;color:var(--text)}
    #match-result th{background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212}
    #match-result td,#match-result th{border:1px solid #444;padding:8px;text-align:center}

    @media (max-width:820px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <nav>
    <button data-target="#section-dashboard">대시보드</button>
    <button data-target="#section-match">자동 팀 생성</button>
    <button data-target="#section-log">내전 기록</button>
  </nav>

  <!-- 대시보드 -->
  <section id="section-dashboard" class="section">
    <div class="toolbar">
      <button id="btn-edit-toggle" class="btn">편집 모드: 꺼짐</button>
      <button id="btn-user-add" class="btn">유저 추가</button>
      <button id="btn-users-save" class="btn">유저 저장</button>
    </div>

    <table id="userTable" class="display">
      <thead>
        <tr>
          <th>No</th><th>이름</th><th>티어</th><th>레이팅</th><th>주라인</th><th>부라인</th>
          <th>판수</th><th>승리</th><th>패배</th><th>승률</th><th>최근 경기</th><th>메뉴</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 자동 팀 생성 -->
  <section id="section-match" class="section" style="display:none">
    <div class="grid-2" id="match-team"></div>
    <div class="toolbar" style="margin-top:16px">
      <button id="btn-match" class="btn">매칭하기</button>
      <button id="btn-clear-match" class="btn">선택 초기화</button>
    </div>

    <div id="match-result">
      <h3>팀 매치 결과</h3>
      <table>
        <thead><tr><th>블루팀</th><th>레드팀</th></tr></thead>
        <tbody><tr><td colspan="2" style="text-align:center">매칭하기 버튼을 눌러 결과 확인</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- 내전 기록 -->
  <section id="section-log" class="section" style="display:none">
    <div class="grid-2" id="log-players"></div>
    <div class="toolbar">
      <button id="btn-log-save" class="btn">기록 저장</button>
    </div>

    <div id="log-result">
      <h3>최근 기록</h3>
      <table id="logTable" class="display">
        <thead>
          <tr>
            <th>시간</th>
            <th>승리팀</th>
            <th>패배팀</th>
            <th>메뉴</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
  $(document).ready(function(){

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyBVAVqBNePwpYzBYpIt68S93toyQPGbOuk",
      authDomain: "datebase-6d247.firebaseapp.com",
      projectId: "datebase-6d247",
      storageBucket: "datebase-6d247.firebasestorage.app",
      messagingSenderId: "720823690695",
      appId: "1:720823690695:web:f80544a7604eb9ac2da5e2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 유틸
    function calculateWinRate(win, match){ return match===0? '0%': Math.round((win/match)*100)+"%"; }
    function getTierByRating(r){
      const rating = Number(r)||0;
      if(rating>=3000)return'챌린저';
      if(rating>=2900)return'그마';
      if(rating>=2800)return'마스터 3';
      if(rating>=2700)return'마스터 2';
      if(rating>=2600)return'마스터 1';
      if(rating>=2500)return'마스터 0';
      if(rating>=2450)return'다이아 1';
      if(rating>=2400)return'다이아 2';
      if(rating>=2350)return'다이아 3';
      if(rating>=2300)return'다이아 4';
      if(rating>=2250)return'다이아 5';
      if(rating>=2200)return'에메랄드 1';
      if(rating>=2150)return'에메랄드 2';
      if(rating>=2100)return'에메랄드 3';
      if(rating>=2050)return'에메랄드 4';
      if(rating>=2000)return'에메랄드 5';
      if(rating>=1950)return'플레티넘 1';
      if(rating>=1900)return'플레티넘 2';
      if(rating>=1850)return'플레티넘 3';
      if(rating>=1800)return'플레티넘 4';
      if(rating>=1750)return'플레티넘 5';
      if(rating>=1700)return'골드 1';
      if(rating>=1650)return'골드 2';
      if(rating>=1600)return'골드 3';
      if(rating>=1550)return'골드 4';
      if(rating>=1500)return'골드 5';
      if(rating>=1450)return'실버 1';
      if(rating>=1400)return'실버 2';
      if(rating>=1350)return'실버 3';
      if(rating>=1300)return'실버 4';
      if(rating>=1250)return'실버 5';
      if(rating>=1200)return'브론즈 1';
      if(rating>=1150)return'브론즈 2';
      if(rating>=1100)return'브론즈 3';
      if(rating>=1050)return'브론즈 4';
      if(rating>=1000)return'브론즈 5';
      return'아이언';
    }

    function applyTierColors(){
      const colors={
        '아이언':['#fff','#121212'], '브론즈':['#DEB84F','#121212'], '실버':['#BDBDBD','#121212'],
        '골드':['#FAED7D','#121212'], '플레티넘':['#ABF200','#121212'], '에메랄드':['#2FED28','#121212'],
        '다이아':['#00D8FF','#121212'], '마스터':['#C98AFF','#121212'], '그마':['#FF3636','#121212'], '챌린저':['linear-gradient(to right,#ffd700,#1e90ff)','#121212']
      };
      $('#userTable tbody tr').each(function(){
        const td = $(this).find('td').eq(2); // 티어 칸
        const tier = td.text().trim();
        let bg='#2a2a2a', color='#f0f0f0';
        for(const k in colors){ if(tier.includes(k)){ bg=colors[k][0]; color=colors[k][1]; break; } }
        if(tier.includes('챌린저')) td.css('background',bg);
        else td.css('background-color',bg);
        td.css('color',color).css('font-weight','700');
      });
    }

    // DataTable 초기화
    let dtInstance = $('#userTable').DataTable({
      paging:false, data:[], autoWidth:false,
      columns:[
        {data:null, render:(d,t,r,m)=>m.row+1},
        {data:"userName"}, {data:"tier"}, {data:"rating"}, {data:"mainLane"}, {data:"subLane"},
        {data:"matchNumber"}, {data:"win"}, {data:"loss"}, {data:"winRate"}, {data:"lastPlayDateSince"},
        {data:null, defaultContent:'<button class="btn btn-del">삭제</button>', orderable:false}
      ],
      columnDefs:[{targets:1,width:'17%',className:'dt-left'},{targets:[4,5],width:'7%'},{targets:10,width:'8%'}]
    });

    let editable=false;

    const usersCol = db.collection('users');
    usersCol.orderBy('userName').onSnapshot((snap)=>{
      const users = snap.docs.map(d=>d.data());
      dtInstance.clear().rows.add(users).draw();
      applyTierColors();
      refreshAllSelects();
    });

    // 네비게이션
    $('nav button').click(function(){
      const target=$(this).data('target');
      $('.section').hide();
      $(target).show();
    });

    // 편집 모드 토글
    $('#btn-edit-toggle').click(function(){
      editable=!editable;
      $(this).text(`편집 모드: ${editable?'켜짐':'꺼짐'}`);
    });

    // 유저 추가
    $('#btn-user-add').click(async function(){
      const name=prompt('이름을 입력하세요');
      if(!name) return;
      const id=crypto.randomUUID();
      const rating=1000;
      const newUser={
        userId:id,userName:name,rating,
        mainLane:'-',subLane:'-',win:0,loss:0,
        matchNumber:0,winRate:'0%',tier:getTierByRating(rating),lastPlayDateSince:'-'
      };
      await usersCol.doc(id).set(newUser);
    });

    // 유저 삭제
    $('#userTable tbody').on('click','.btn-del', async function(){
      const row = dtInstance.row($(this).closest('tr'));
      const data = row.data();
      if(!confirm(`정말 삭제하시겠습니까? (${data.userName})`)) return;
      await usersCol.doc(data.userId).delete();
    });

    // inline edit
    $('#userTable tbody').on('click','td',function(){
      if(!editable) return;
      const cell = dtInstance.cell(this);
      const col = cell.index().column;
      if([0,2,6,9,11].includes(col)) return;
      const orig=cell.data();
      const $input=$('<input>').val(orig);
      if([3,7,8].includes(col)) $input.attr('type','number').attr('min',0);
      $(this).html($input).closest('tr').addClass('editing');
      $input.focus();
      const finish=async()=>{
        let val=$input.val();
        if([3,7,8].includes(col)){ val=val===''?0:Number(val); if(isNaN(val)) val=0; }
        const rowData=dtInstance.row(cell.index().row).data();
        const updated={...rowData};
        const map={1:'userName',3:'rating',4:'mainLane',5:'subLane',7:'win',8:'loss',10:'lastPlayDateSince'};
        const key=map[col];
        updated[key]=val;
        updated.win=parseInt(updated.win)||0; updated.loss=parseInt(updated.loss)||0;
        updated.matchNumber=updated.win+updated.loss;
        updated.winRate=calculateWinRate(updated.win,updated.matchNumber);
        if(col===3) updated.tier=getTierByRating(parseInt(updated.rating)||0);
        await usersCol.doc(updated.userId).set(updated);
      };
      $input.on('blur',finish).on('keydown',e=>{
        if(e.key==='Enter') finish();
        if(e.key==='Escape'){ cell.data(orig).draw(false); }
      });
    });

    // 전체 저장
    $('#btn-users-save').click(async function(){
      const rows = dtInstance.rows().data().toArray();
      const ops = rows.map(u=>{
        const upd={...u};
        upd.matchNumber=(parseInt(upd.win)||0)+(parseInt(upd.loss)||0);
        upd.winRate=calculateWinRate(parseInt(upd.win)||0,upd.matchNumber);
        upd.tier=getTierByRating(parseInt(upd.rating)||0);
        return usersCol.doc(u.userId).set(upd);
      });
      await Promise.all(ops);
      alert('저장 완료');
    });

    // Select2 초기화
    function refreshAllSelects(){
      $('.match-p').select2({placeholder:'선택',width:'resolve'}).empty();
      $('.log-p').select2({placeholder:'선택',width:'resolve'}).empty();
      const names = dtInstance.rows().data().toArray().map(u=>u.userName);
      $('.match-p,.log-p').each(function(){
        names.forEach(n=>$(this).append(`<option>${n}</option>`));
      });
    }

  });
  </script>
</body>
</html>
